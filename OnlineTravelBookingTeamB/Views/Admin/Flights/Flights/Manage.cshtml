@model OnlineTravelBookingTeamB.Models.ManageFlightViewModel
@{
    ViewData["Title"] = $"Manage Flight - {Model.Flight.FlightNumber}";
    var flight = Model.Flight;
    var duration = flight.Schedule.End - flight.Schedule.Start;
}

<div class="admin-container">
    <div class="container py-5">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-end mb-5 pb-4 border-bottom">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index">Admin</a></li>
                        <li class="breadcrumb-item"><a asp-action="Index">Flights</a></li>
                        <li class="breadcrumb-item active">@flight.FlightNumber</li>
                    </ol>
                </nav>
                <div class="d-flex align-items-center gap-3">
                    <h1 class="fw-bold mb-0">@flight.FlightNumber</h1>
                    <span class="badge bg-primary-soft text-primary px-3 rounded-pill">Flight Active</span>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a asp-action="Index" class="btn btn-outline-secondary px-4 rounded-3 text-dark border-light shadow-sm bg-white">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
                <a asp-action="Edit" asp-route-id="@flight.Id" class="btn btn-primary px-4 rounded-3 shadow-sm">
                    <i class="fas fa-cog me-2"></i>Config
                </a>
            </div>
        </div>

        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success border-0 shadow-sm rounded-3 mb-4 d-flex align-items-center p-3">
                <i class="fas fa-check-circle me-3 fs-4 text-success"></i>
                <div class="fw-medium">@TempData["Success"]</div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Route Card -->
        <div class="card border rounded-4 shadow-sm bg-white mb-5">
            <div class="card-body p-4 p-md-5">
                <div class="row align-items-center">
                    <div class="col-md-4 text-center text-md-start">
                        <h2 class="fw-black display-6 mb-0">@flight.OriginAirport?.Code?.Value</h2>
                        <div class="fw-bold text-muted small">@flight.OriginAirport?.Name</div>
                        <div class="mt-3">
                            <span class="fw-bold fs-5">@flight.Schedule.Start.ToString("HH:mm")</span>
                            <span class="ms-2 text-muted">@flight.Schedule.Start.ToString("MMM dd")</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-center py-4 py-md-0">
                        <div class="d-flex flex-column align-items-center">
                            <span class="badge bg-light text-dark rounded-pill mb-2 px-3 fw-bold">@((int)duration.TotalHours)h @(duration.Minutes)m</span>
                            <div class="w-100 position-relative d-flex align-items-center">
                                <hr class="w-100 m-0 border-2">
                                <i class="fas fa-plane text-primary position-absolute start-50 top-50 translate-middle bg-white px-3"></i>
                            </div>
                            <span class="text-muted x-small fw-bold mt-2">DUR_TOTAL</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-center text-md-end">
                        <h2 class="fw-black display-6 mb-0">@flight.DestinationAirport?.Code?.Value</h2>
                        <div class="fw-bold text-muted small">@flight.DestinationAirport?.Name</div>
                        <div class="mt-3">
                            <span class="fw-bold fs-5">@flight.Schedule.End.ToString("HH:mm")</span>
                            <span class="ms-2 text-muted">@flight.Schedule.End.ToString("MMM dd")</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-5">
            <div class="col-lg-8">
                <!-- Tabbed Management -->
                <ul class="nav nav-tabs border-0 bg-light p-1 rounded-3 mb-4" role="tablist">
                    <li class="nav-item flex-fill">
                        <button class="nav-link active w-100 rounded-2 fw-bold" data-bs-toggle="tab" data-bs-target="#seats">Cabin & Seats</button>
                    </li>
                    <li class="nav-item flex-fill">
                        <button class="nav-link w-100 rounded-2 fw-bold" data-bs-toggle="tab" data-bs-target="#fares">Fares & Pricing</button>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="seats">
                        <div class="d-flex justify-content-between align-items-center mb-4 ps-1">
                            <h4 class="fw-bold mb-0">Seat Categories</h4>
                            <button class="btn btn-dark btn-sm rounded-2 px-3 fw-bold" data-bs-toggle="modal" data-bs-target="#addSeatModal">
                                Add Cabin
                            </button>
                        </div>
                        <div class="row g-3">
                            @foreach (var seat in flight.Seats)
                            {
                                <div class="col-md-6">
                                    <div class="card border rounded-4 bg-white p-4 h-100">
                                        <div class="d-flex justify-content-between mb-3">
                                            <h6 class="fw-bold mb-0">@seat.CabinClass</h6>
                                            <form asp-action="DeleteSeat" asp-route-id="@seat.Id" asp-route-flightId="@flight.Id" method="post" data-confirm="Are you sure you want to delete this seat class?" data-confirm-title="Delete Seats">
                                                <button type="submit" class="btn-clean text-danger"><i class="fas fa-trash-alt"></i></button>
                                            </form>
                                        </div>
                                        <div class="mb-3">
                                            <span class="badge bg-light text-muted border px-2">Rows: @seat.SeatLabel</span>
                                        </div>
                                        <div class="mt-auto pt-3 border-top d-flex justify-content-between align-items-center">
                                            <span class="small text-muted">Upcharge:</span>
                                            <span class="fw-bold @(seat.ExtraCharge?.Amount > 0 ? "text-success" : "text-muted")">@(seat.ExtraCharge?.Amount > 0 ? $"+${seat.ExtraCharge.Amount:N0}" : "FREE")</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="tab-pane fade" id="fares">
                        <div class="d-flex justify-content-between align-items-center mb-4 ps-1">
                            <h4 class="fw-bold mb-0">Fare Classes</h4>
                            <button class="btn btn-primary btn-sm rounded-2 px-3 fw-bold" data-bs-toggle="modal" data-bs-target="#addFareModal">
                                Release Fare
                            </button>
                        </div>
                        <div class="table-card border rounded-4 overflow-hidden bg-white">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Price</th>
                                        <th>Inventory</th>
                                        <th class="text-end pe-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var fare in flight.Fares)
                                    {
                                        <tr>
                                            <td class="ps-4 fw-bold fs-5 text-dark">$@fare.BasePrice?.Amount.ToString("N2")</td>
                                            <td><span class="badge bg-primary-soft text-primary px-3 rounded-pill">@fare.SeatsAvailable Available</span></td>
                                            <td class="text-end pe-4">
                                                <form asp-action="DeleteFare" asp-route-id="@fare.Id" asp-route-flightId="@flight.Id" method="post" data-confirm="Are you sure you want to delete this fare class?" data-confirm-title="Delete Fare">
                                                    <button type="submit" class="btn-clean text-danger"><i class="fas fa-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border rounded-4 p-4 bg-white mb-4">
                    <h6 class="fw-bold text-uppercase x-small text-muted mb-4">Operational Meta</h6>
                    
                    <div class="mb-3">
                        <label class="x-small fw-bold text-muted d-block mb-1">Carrier Provider</label>
                        <div class="d-flex align-items-center">
                            @if (!string.IsNullOrEmpty(flight.Carrier?.Logo)) {
                                <img src="@flight.Carrier.Logo" alt="@flight.Carrier.Name" class="me-2" style="height: 20px;" />
                            }
                            <span class="fw-bold">@flight.Carrier?.Name</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="x-small fw-bold text-muted d-block mb-1">Aircraft</label>
                        <span class="fw-bold">@(flight.Metadata?.AircraftType ?? "N/A")</span>
                    </div>

                    <div class="mb-3">
                        <label class="x-small fw-bold text-muted d-block mb-1">Gate / Terminal</label>
                        <span class="fw-bold">T@(flight.Metadata?.Terminal ?? "1") / Gate @(flight.Metadata?.Gate ?? "A")</span>
                    </div>

                    <hr class="my-4">

                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <span class="small fw-bold text-muted">Refundable:</span>
                        <span class="badge @(flight.Refundable ? "bg-success" : "bg-danger") rounded-pill">@(flight.Refundable ? "YES" : "NO")</span>
                    </div>
                </div>

                <div class="card border-0 rounded-4 p-4 bg-primary text-white shadow-sm">
                    <h6 class="fw-bold mb-3 x-small text-uppercase">Baggage Rules</h6>
                    <ul class="list-unstyled mb-0">
                        @if (flight.BaggageRules != null)
                        {
                            @foreach (var rule in flight.BaggageRules)
                            {
                                <li class="small mb-1"><i class="fas fa-check-circle me-2 opacity-50"></i>@rule</li>
                            }
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="addSeatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">New Cabin Config</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="AddSeat" method="post">
                <input type="hidden" asp-for="SeatForm.FlightId" value="@flight.Id" />
                <div class="modal-body p-4">
                    <div class="mb-3">
                         <label class="form-label small fw-bold">Row Label</label>
                         <input asp-for="SeatForm.SeatLabel" class="form-control" placeholder="e.g. 1-10" required />
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Class</label>
                            <select asp-for="SeatForm.CabinClass" class="form-select">
                                <option value="Economy">Economy</option>
                                <option value="Business">Business</option>
                                <option value="FirstClass">First Class</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Charge ($)</label>
                            <input name="SeatForm.ExtraCharge" type="number" step="0.01" class="form-control" value="0.00" />
                        </div>
                    </div>
                    <div>
                        <label class="form-label small fw-bold">Features (Comma Sep)</label>
                        <input name="SeatForm.SeatFeaturesText" class="form-control" placeholder="WiFi, Window" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark px-4">Save Config</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addFareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Price Release</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="AddFare" method="post">
                <input type="hidden" asp-for="FareForm.FlightId" value="@flight.Id" />
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label small fw-bold">Price</label>
                            <input name="FareForm.BasePrice" type="number" step="0.01" class="form-control" required />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">Currency</label>
                            <input name="FareForm.Currency" class="form-control" value="USD" readonly />
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold">Quantity</label>
                            <input name="FareForm.SeatsAvailable" type="number" class="form-control" required />
                        </div>
                    </div>
                </div>
                <div class="modal-footer pt-0 border-0">
                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-2">Release Tickets</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    body { font-family: 'Inter', sans-serif; background-color: #fcfdfe; color: #1a1a1b; }
    .fw-black { font-weight: 800; letter-spacing: -1px; }
    .x-small { font-size: 0.73rem; letter-spacing: 0.4px; }
    .bg-primary-soft { background-color: rgba(0, 102, 255, 0.08); }
    .rounded-4 { border-radius: 1rem !important; }
    .nav-tabs .nav-link { border: 0 !important; color: #64748b; padding: 0.8rem; }
    .nav-tabs .nav-link.active { background-color: #fff !important; color: #000 !important; shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .btn-clean { background: transparent; border: 0; padding: 0; transition: 0.2s; opacity: 0.7; }
    .btn-clean:hover { opacity: 1; }
    .breadcrumb-item a { text-decoration: none; color: #6c757d; font-weight: 500; }
    .form-control, .form-select { border: 1px solid #e2e8f0; padding: 0.65rem 1rem; border-radius: 0.6rem; font-size: 0.95rem; }
</style>
