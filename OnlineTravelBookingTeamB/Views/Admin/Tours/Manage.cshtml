@model OnlineTravelBookingTeamB.Models.ManageTourViewModel
@{
    ViewData["Title"] = $"Manage {Model.Tour.Title}";
    var tour = Model.Tour;
}

<div class="container-fluid py-4 min-vh-100 bg-light-gradient">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index" class="text-primary-soft">Admin</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index" class="text-primary-soft">Tours</a></li>
                    <li class="breadcrumb-item active">@tour.Title</li>
                </ol>
            </nav>
            <div class="d-flex align-items-center">
                <h1 class="h2 fw-bold text-dark mb-0">
                    <i class="fas fa-map-marked-alt text-success me-2"></i>@tour.Title
                </h1>
                @if (tour.Recommended)
                {
                    <span class="badge bg-warning-light text-warning border border-warning-subtle rounded-pill px-3 ms-3 py-2">
                        <i class="fas fa-crown me-1"></i>Recommended
                    </span>
                }
            </div>
        </div>
        <div class="col-auto">
            <a asp-action="Index" class="btn btn-outline-secondary border-0 rounded-pill px-4 bg-white shadow-sm">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success border-0 shadow-sm rounded-4 animate__animated animate__fadeInDown mb-4">
            <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close float-end" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row g-4">
        <!-- Main Content (Left) -->
        <div class="col-lg-8">
            <!-- Tour Overview Section -->
            <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white overflow-hidden">
                <div class="row g-0">
                    <div class="col-md-5 position-relative">
                        <img src="/@(tour.MainImageUrl ?? "images/placeholder-tour.jpg")" class="img-fluid h-100 w-100 object-fit-cover" alt="@tour.Title">
                        <div class="position-absolute bottom-0 start-0 p-3 bg-dark bg-opacity-50 text-white w-100 backdrop-blur">
                            <i class="fas fa-calendar-alt me-2"></i>@tour.DurationDays Days / @tour.DurationNights Nights
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="fw-bold text-dark">Adventure Details</h5>
                                <button class="btn btn-sm btn-outline-primary rounded-pill px-3 border-light shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#editTourSection">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <p class="text-muted small mb-4">@tour.Description</p>
                            <div class="row g-3">
                                <div class="col-6">
                                    <span class="text-muted d-block small">Category</span>
                                    <span class="fw-bold">@tour.Category</span>
                                </div>
                                <div class="col-6">
                                    <span class="text-muted d-block small">Expected Rating</span>
                                    <span class="text-warning fw-bold"><i class="fas fa-star me-1"></i>@tour.Rating.ToString("0.0")</span>
                                </div>
                                <div class="col-12 mt-3">
                                    <span class="text-muted d-block small mb-1">Destinations</span>
                                    <div class="d-flex flex-wrap gap-1">
                                        <span class="badge bg-light text-dark border rounded-pill px-3">@tour.Location?.City</span>
                                        <span class="badge bg-light text-dark border rounded-pill px-3">@tour.Location?.Country</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="collapse border-top" id="editTourSection">
                    <div class="card-body p-4 bg-light-soft">
                        <form asp-action="Update" method="post" enctype="multipart/form-data">
                            <input type="hidden" asp-for="EditForm.TourId" value="@tour.Id" />
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label fw-bold small">Tour Title</label>
                                    <input asp-for="EditForm.Title" class="form-control rounded-3 border-light shadow-sm" value="@tour.Title" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Days</label>
                                    <input asp-for="EditForm.DurationDays" type="number" class="form-control rounded-3 border-light shadow-sm" value="@tour.DurationDays" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Nights</label>
                                    <input asp-for="EditForm.DurationNights" type="number" class="form-control rounded-3 border-light shadow-sm" value="@tour.DurationNights" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">Full Description</label>
                                    <textarea asp-for="EditForm.Description" class="form-control rounded-3 border-light shadow-sm" rows="5">@tour.Description</textarea>
                                </div>
                                <div class="col-12 text-end">
                                    <button type="submit" class="btn btn-primary rounded-pill px-5">Save Information</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Itinerary / Timeline Section -->
            <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold text-dark mb-0"><i class="fas fa-hiking text-primary me-2"></i>Itinerary Builder</h5>
                    <button class="btn btn-sm btn-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#addActivityModal">
                        <i class="fas fa-plus me-1"></i>Add Activity
                    </button>
                </div>
                <div class="card-body p-4">
                    <div class="itinerary-timeline mt-2">
                        @if (tour.Activities != null && tour.Activities.Any())
                        {
                            @foreach (var activity in tour.Activities)
                            {
                                <div class="timeline-item pb-4 position-relative">
                                    <div class="timeline-marker bg-primary"></div>
                                    <div class="card border-light shadow-none rounded-3 bg-light-soft">
                                        <div class="card-body p-3">
                                            <div class="row align-items-center">
                                                <div class="col-auto">
                                                    @if (!string.IsNullOrEmpty(activity.ImageUrl))
                                                    {
                                                        <img src="/@activity.ImageUrl" class="rounded-3 shadow-sm" style="width: 60px; height: 60px; object-fit: cover;" />
                                                    }
                                                    else
                                                    {
                                                        <div class="bg-light rounded-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                            <i class="fas fa-camera text-muted opacity-25"></i>
                                                        </div>
                                                    }
                                                </div>
                                                <div class="col">
                                                    <h6 class="fw-bold mb-1">@activity.Title</h6>
                                                    <p class="text-muted small mb-0">@activity.Description</p>
                                                </div>
                                                @* 
                                                <div class="col-auto text-end">
                                                    <form asp-action="DeleteActivity" asp-route-id="@activity.Id" asp-route-tourId="@tour.Id" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-icon-soft text-danger-soft" onclick="return confirm('Remove this activity?')">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                                *@
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-4 text-muted border border-dashed rounded-4 bg-light-soft">
                                <p class="mb-0">No activities planned yet. Start building the journey!</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Price Tiers -->
            <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-bold text-dark mb-0"><i class="fas fa-tags text-info me-2"></i>Dynamic Pricing Tiers</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        @if (tour.PriceTiers != null && tour.PriceTiers.Any())
                        {
                            @foreach (var tier in tour.PriceTiers)
                            {
                                <div class="col-md-4">
                                    <div class="tier-card p-3 rounded-4 border text-center hover-lift position-relative overflow-hidden">
                                        <div class="badge bg-info-light text-info rounded-pill px-3 mb-2">@tier.Name</div>
                                        <h3 class="fw-black text-dark mb-0">$@tier.Price.Amount.ToString("N0")</h3>
                                        <p class="text-muted small mb-3">per person</p>
                                        @* 
                                        <form asp-action="DeletePriceTier" asp-route-id="@tier.Id" asp-route-tourId="@tour.Id" method="post">
                                            <button type="submit" class="btn btn-sm btn-outline-danger w-100 rounded-pill border-light" onclick="return confirm('Delete tier?')">Delete</button>
                                        </form>
                                        *@
                                    </div>
                                </div>
                            }
                        }
                        <div class="col-md-4">
                            <button class="tier-card p-3 rounded-4 border border-dashed text-center w-100 h-100 bg-light-soft text-muted hover-lift" 
                                    data-bs-toggle="modal" data-bs-target="#addPriceTierModal">
                                <i class="fas fa-plus fa-2x mb-2 opacity-50"></i>
                                <span class="d-block fw-bold small">New Tier</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Content (Right) -->
        <div class="col-lg-4">
            <!-- Location & Map -->
            <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white overflow-hidden">
                <div class="card-body p-0">
                    <div id="tourMap" style="height: 250px; background: #eee;">
                        <!-- Map loading placeholder -->
                        <div class="h-100 d-flex align-items-center justify-content-center flex-column text-muted">
                            <i class="fas fa-map-marked-alt fa-3x mb-2 opacity-25"></i>
                            <span class="small">Interactive Map View</span>
                        </div>
                    </div>
                    <div class="p-4">
                        <h6 class="fw-bold mb-3">Location Details</h6>
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-map-pin text-danger me-2"></i>
                            <span class="small text-dark fw-medium">@tour.Location?.City, @tour.Location?.Country</span>
                        </div>
                        <p class="text-muted small mb-0">@tour.Location?.Street</p>
                        <button class="btn btn-sm btn-light-soft w-100 rounded-pill mt-3 border" data-bs-toggle="modal" data-bs-target="#updateLocationModal">
                            Update Coordinates
                        </button>
                    </div>
                </div>
            </div>

            <!-- Image Gallery -->
            <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0">Gallery</h6>
                    <button class="btn btn-sm btn-outline-primary rounded-pill px-3 border-light py-0" data-bs-toggle="modal" data-bs-target="#addImageModal">
                        <i class="fas fa-plus small"></i>
                    </button>
                </div>
                <div class="card-body p-4">
                    <div class="row g-2">
                        @if (tour.Images != null && tour.Images.Any())
                        {
                            @foreach (var img in tour.Images)
                            {
                                <div class="col-4">
                                    <div class="gallery-item rounded-3 overflow-hidden position-relative">
                                        <img src="/@img.Url" class="img-fluid object-fit-cover w-100" style="height: 60px;" alt="@img.AltText" />
                                        <div class="gallery-overlay d-flex align-items-center justify-content-center">
                                            @* 
                                            <form asp-action="DeleteTourImage" asp-route-id="@img.Id" asp-route-tourId="@tour.Id" method="post">
                                                <button type="submit" class="btn text-white p-0"><i class="fas fa-times-circle"></i></button>
                                            </form>
                                            *@
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                    @if (tour.Images == null || !tour.Images.Any())
                    {
                        <p class="text-center text-muted small py-3 mb-0">No extra gallery images</p>
                    }
                </div>
            </div>

            <!-- Booking Stats (Placeholder for Premium look) -->
            <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white">
                <div class="card-body p-4">
                    <h6 class="fw-bold mb-3">Performance</h6>
                    <div class="d-flex align-items-center mb-3">
                        <div class="progress flex-grow-1 bg-light rounded-pill" style="height: 8px;">
                            <div class="progress-bar bg-success rounded-pill" style="width: 75%"></div>
                        </div>
                        <span class="ms-3 fw-bold small">75%</span>
                    </div>
                    <p class="text-muted small mb-0">This tour is in the top 10% of popular choices this season.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Activity -->
<div class="modal fade" id="addActivityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="modal-title fw-bold">Plan New Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="AddActivity" method="post" enctype="multipart/form-data">
                <input type="hidden" asp-for="ActivityForm.TourId" value="@tour.Id" />
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Title</label>
                        <input asp-for="ActivityForm.Title" class="form-control rounded-3" placeholder="e.g. Scuba Diving" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Description</label>
                        <textarea asp-for="ActivityForm.Description" class="form-control rounded-3" rows="3"></textarea>
                    </div>
                    <div class="mb-0">
                        <label class="form-label small fw-bold">Main Image</label>
                        <input asp-for="ActivityForm.Image" type="file" class="form-control rounded-3" />
                    </div>
                </div>
                <div class="modal-footer border-0 pb-4 px-4">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">Save Activity</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Add Price Tier -->
<div class="modal fade" id="addPriceTierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="modal-title fw-bold">New Price Tier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="AddPriceTier" method="post">
                <input type="hidden" asp-for="PriceTierForm.TourId" value="@tour.Id" />
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Tier Name</label>
                        <input asp-for="PriceTierForm.Name" class="form-control rounded-3" placeholder="e.g. Early Bird" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Price per Person ($)</label>
                        <input asp-for="PriceTierForm.Amount" type="number" step="0.01" class="form-control rounded-3" required />
                    </div>
                    <div class="mb-0">
                        <label class="form-label small fw-bold">Min Participants (optional)</label>
                        @* <input asp-for="PriceTierForm.MinParticipants" type="number" class="form-control rounded-3" value="1" /> *@
                    </div>
                </div>
                <div class="modal-footer border-0 pb-4 px-4">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info text-white rounded-pill px-4 shadow-sm">Add Tier</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Add Gallery Image -->
<div class="modal fade" id="addImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="modal-title fw-bold">Add to Gallery</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="AddImage" method="post" enctype="multipart/form-data">
                <input type="hidden" asp-for="ImageForm.TourId" value="@tour.Id" />
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Select Image</label>
                        <input asp-for="ImageForm.Image" type="file" class="form-control rounded-3" required />
                    </div>
                    <div class="mb-0">
                        <label class="form-label small fw-bold">Alternative Text</label>
                        <input asp-for="ImageForm.AltText" class="form-control rounded-3" placeholder="Short description" />
                    </div>
                </div>
                <div class="modal-footer border-0 pb-4 px-4">
                    <button type="submit" class="btn btn-primary rounded-pill w-100 shadow-sm">Upload Image</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .bg-light-gradient { background: radial-gradient(circle at top right, #f8f9ff 0%, #f0f2f5 100%); }
    .text-primary-soft { color: #5d78ff; text-decoration: none; transition: color 0.2s; }
    .text-primary-soft:hover { color: #3d5afe; }
    
    .fw-black { font-weight: 800; letter-spacing: -0.5px; }
    .backdrop-blur { backdrop-filter: blur(4px); }

    /* Timeline Styles */
    .itinerary-timeline { position: relative; padding-left: 20px; }
    .itinerary-timeline::before {
        content: '';
        position: absolute;
        left: 0;
        top: 10px;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }
    .timeline-item { position: relative; }
    .timeline-marker {
        position: absolute;
        left: -24px;
        top: 10px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 0 2px rgba(93, 120, 255, 0.3);
    }

    /* Card Tier Hover */
    .tier-card { transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); background: white; border-color: #f1f1f1 !important; }
    .tier-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: #5d78ff !important; }

    /* Gallery Overlay */
    .gallery-item:hover .gallery-overlay { opacity: 1; }
    .gallery-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(220, 53, 69, 0.8);
        opacity: 0;
        transition: opacity 0.2s;
        cursor: pointer;
    }

    .bg-info-light { background-color: rgba(30, 189, 218, 0.1); }
    .bg-warning-light { background-color: rgba(255, 193, 7, 0.1); }
    .bg-light-soft { background-color: #f9fbfd; }

    .btn-icon-soft { width: 34px; height: 34px; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; background-color: #f8f9fa; border: none; transition: all 0.2s; }
    .btn-icon-soft:hover { background-color: #eff2f7; color: #4361ee; }
    .text-danger-soft { color: #ff5e5e; }

    .rounded-4 { border-radius: 1.25rem !important; }
    .rounded-3 { border-radius: 0.75rem !important; }
    
    .object-fit-cover { object-fit: cover; }
    .hover-lift:hover { transform: translateY(-3px); }
</style>
