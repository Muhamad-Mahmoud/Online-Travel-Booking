@model AdminDashboardResponse
@using System.Text.Json;
@using OnlineTravelBookingTeamB.Helpers
@{
    ViewData["Title"] = "Overview";
    var revenueData = JsonSerializer.Serialize(Model.RevenueAnalytics.Select(m => m.Revenue));
    var categoryLabels = JsonSerializer.Serialize(Model.CategoryDistribution.Select(c => c.Category));
    var categoryData = JsonSerializer.Serialize(Model.CategoryDistribution.Select(c => c.Count));
}

<div class="page-title">
    Dashboard Overview
    <a asp-action="ExportBookingsReport" class="btn btn-primary btn-sm rounded-3 shadow-sm px-3">
        <i class="fas fa-download me-2"></i> Export Report
    </a>
</div>

<!-- Stats Grid -->
<div class="card-grid">
    <!-- Stat Card 1 -->
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">Total Revenue</span>
            <div class="stat-icon bg-primary-light">
                <i class="fas fa-dollar-sign"></i>
            </div>
        </div>
        <div class="stat-value">$@Model.TotalRevenue.ToString("N0")</div>
        <div class="stat-change change-up">
            <i class="fas fa-arrow-up"></i>
            <span>Calculated from confirmed bookings</span>
        </div>
    </div>

    <!-- Stat Card 2 -->
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">New Bookings</span>
            <div class="stat-icon bg-info-light">
                <i class="fas fa-ticket-alt"></i>
            </div>
        </div>
        <div class="stat-value">@Model.NewBookingsCount</div>
        <div class="stat-change change-up">
            <i class="fas fa-arrow-up"></i>
            <span>In the last 30 days</span>
        </div>
    </div>

    <!-- Stat Card 3 -->
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">Active Tours</span>
            <div class="stat-icon bg-success-light">
                <i class="fas fa-route"></i>
            </div>
        </div>
        <div class="stat-value">@Model.ActiveToursCount</div>
        <div class="stat-change text-muted">
            <i class="fas fa-info-circle"></i>
            <span>Upcoming schedules</span>
        </div>
    </div>

    <!-- Stat Card 4 -->
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">Pending Requests</span>
            <div class="stat-icon bg-warning-light">
                <i class="fas fa-clock"></i>
            </div>
        </div>
        <div class="stat-value">@Model.PendingRequestsCount</div>
        <div class="stat-change text-warning">
            <i class="fas fa-exclamation-circle"></i>
            <span>Awaiting payment</span>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="chart-row">
    <!-- Revenue Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <h6 class="chart-title">Revenue Analytics (@DateTime.Now.Year)</h6>
            <select class="btn-sm-action">
                <option>Monthly View</option>
            </select>
        </div>
        <div style="height: 300px;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <!-- Category Distribution -->
    <div class="chart-card">
        <div class="chart-header">
            <h6 class="chart-title">Booking Categories</h6>
            <button class="btn-sm-action"><i class="fas fa-ellipsis-h"></i></button>
        </div>
        <div style="height: 300px; display: flex; align-items: center; justify-content: center;">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="card shadow-sm border-0 rounded-4 overflow-hidden mb-4">
    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
        <h6 class="m-0 fw-bold text-dark">Recent Bookings</h6>
        <a asp-controller="Admin" asp-action="Bookings" class="btn btn-sm btn-light">View All</a>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-muted small text-uppercase">
                <tr>
                    <th class="ps-4 py-3 border-0">Reference</th>
                    <th class="py-3 border-0">Customer</th>
                    <th class="py-3 border-0">Service</th>
                    <th class="py-3 border-0">Date</th>
                    <th class="py-3 border-0">Amount</th>
                    <th class="pe-4 py-3 border-0 text-end">Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var booking in Model.RecentBookings)
                {
                    <tr>
                        <td class="ps-4 fw-bold">
                            <a asp-controller="Admin" asp-action="BookingDetails" asp-route-id="@booking.Id" class="text-primary text-decoration-none">#@booking.BookingReference</a>
                        </td>
                        <td>@booking.UserName</td>
                        <td><span class="text-dark fw-medium">@booking.ServiceName</span></td>
                        <td class="text-muted small">@booking.Date.ToString("MMM dd, yyyy")</td>
                        <td class="fw-bold">@booking.Amount.ToString("N0") <small class="text-muted">@booking.Currency</small></td>
                        <td class="pe-4 text-end">
                            <span class="badge @booking.Status.GetStatusBadgeClass() bg-opacity-10 px-3 py-2 rounded-pill fw-normal">@booking.Status</span>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
<script>
    // Revenue Line Chart
    const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
    const revenueData = @Html.Raw(revenueData);
    new Chart(ctxRevenue, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
                label: 'Revenue',
                data: revenueData,
                borderColor: '#4361ee',
                backgroundColor: 'rgba(67, 97, 238, 0.05)',
                borderWidth: 3,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#4361ee',
                pointBorderColor: '#fff',
                pointHoverRadius: 6,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Revenue: $' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#e0e6ed' } },
                x: { grid: { display: false } }
            }
        }
    });

    // Category Doughnut Chart
    const ctxCategory = document.getElementById('categoryChart').getContext('2d');
    const categoryLabels = @Html.Raw(categoryLabels);
    const categoryData = @Html.Raw(categoryData);
    
    new Chart(ctxCategory, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryData,
                backgroundColor: ['#4361ee', '#805dca', '#00ab55', '#e2a03f', '#e7515a', '#2196f3'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20, font: { family: "'Inter', sans-serif", size: 12 } } }
            }
        }
    });
</script>
}

